## 订单状态

- 订单未支付 [0]
- 订单已关闭 [-1]
- 订单支付失败 [-2]

### 订单未支付

一个新创建的订单的默认状态为 `0`，代表该订单未支付。

- 若订单 30 分钟内未支付，将被标记为「订单已关闭（Closed）」

- 若订单进行了支付，但支付失败，将被标记为「订单支付失败（Payment Failed）」
- 若订单进行了支付，且支付成功，将被标记为「新订单（New Order）」

### 订单已关闭

- 订单创建成功后，添加一个延时 30 分钟的任务到队列，若 30 分钟内该订单没有被支付，队列会将这个订单状态改为「订单已关闭」，并退还库存
- 用户可以手动关闭未支付的订单，并填写原因（不想买了，地址错了，处方错了……）
- 为符合现在的逻辑，需要写一个脚本 / SQL，将状态为 0 的历史订单的状态改为「订单已关闭」

### 订单支付失败

- 当 [PayPal ](https://developer.paypal.com/docs/classic/ipn/integration-guide/IPNandPDTVariables/?mark=travel+rule?mark=payment_status#buyer-information-variables) 的异步通知的字段 `payment_status` 为 `Failed` 时，将订单状态改为「订单支付失败」
- 当 Ocean 的异步通知的字段 `payment_status` 为 `0` 时，将订单状态改为「订单支付失败」

## 新增功能

新增功能已在 [需求文档]([https://mxancq.axshare.com/#g=1&p=%E5%BE%85%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B%E5%9B%BE](https://mxancq.axshare.com/#g=1&p=待支付流程图)) 列出

## 接口改动

### API

- 「清空购物车数据」的时机从「订单支付成功」移动到「订单创建成功」，即订单创建成功就清空购物车
- 「订单创建」、「订单异步回调」接口做适应性修改，支持「继续支付 / 重新支付」
- 「订单列表」接口要返回「待支付」、「已关闭」、「支付失败」的订单，前端对这些订单的按钮展示要做判断
- 检查项目中涉及到订单状态查询的地方，根据业务需求修改查询条件

### Service

- 「订单管理 -> 订单列表」可以展示、筛选「待支付」、「已关闭」、「支付失败」的订单
- 检查项目中涉及到订单状态查询的地方，根据业务需求修改查询条件

## 工时评估

- 后端预计 3 天，代码改动不是很多，比较占时间的是和前端联调
- 前端方案产品还没有给出，给出后由前端评估