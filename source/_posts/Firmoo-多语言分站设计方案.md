---
title: Firmoo 多语言分站设计方案
date: 2019-08-22 15:43:16
tags:
---

## 多语言分站面临的技术问题：

1. 文本翻译
2. 用户认证
3. 不同时区下数据的存储、展示
4. 代码与数据库耦合
5. 数据库字段翻译问题
6. 搜索引擎 Sphinx、ElasticSeach 部署问题 
7. 多个站点间同时提供同一个资源
8. 华博是否应区分来自不同站点的数据
9. 多站点代码问题



### 文本翻译：

在 API、Service 项目中，许多返回给用户的提示、插入到数据库的日志没有走语言包，这些提示散布在代码的各个角落，并且有些提示是不支持语言包的（比如 API 项目中不同错误代码对应的提示），如何统一管理这些文案？



#### 用户认证问题：

用户是否可以使用一个账户同时登陆多个分站？还是说同一个用户在多个站点间的数据是完全独立的？



#### 时区问题：

```sql
show variables like "%time_zone%";

+------------------+------------+
| Variable_name    | Value      |
+------------------+------------+
| system_time_zone | UTC        |
| time_zone        | US/Pacific |
+------------------+------------+
2 rows in set (0.31 sec)
```


目前线上数据库设定的时区为 UTC+0，API 与 Service 项目时区为 UTC-8（西八区，洛杉矶时区），如何解决不同分站在不同时区下数据的存储、展示问题？



#### 数据库与代码耦合问题：

在 API、Service 项目中都有代码与数据库高度耦合的现象存在，如何解决？



### 数据库字段翻译问题：

目前我们有些这种需求：「Service -> 订单详情页」的所有数据全部全部做中英文翻译，包括存在数据库里的订单日志。

那么分站开设后是否会有这种需求：德语站做德语、英语数据库翻译，西语站做西语、英语数据库翻译。

如果有这种需求，那么如何解决数据库字段翻译问题？



#### 搜索引擎 Sphinx、ElasticSeach 部署问题：

产品搜索使用的引擎 Sphinx 部署在 V1 服务器上，邮件搜索使用的搜索引擎 ElasticSearch 部署在 Service 服务器上。分站使用的搜索引擎该如何部署？



#### 多个站点间提供同一个资源：

比如有这么一个产品，它在多个站点上都可以购买，如何解决只上架一次该产品，就发布到所有的站点（或者只发布到某几个特定的站点）？



#### 华博是否应区分来自不同站点的数据：

目前华博系统只有一套，华博是否应为多站点做些适应性的升级，或者开多套系统？



### 多站点代码同步问题：

如何做到代码只发布一次，就将功能部署到全部站点上（或只部署到某几个特定站点）？



## 多语言分站的解决方案：

1. 将分站与主站完全分离，使用新的服务器、新的数据库，并 fork 一份主站代码作为分站代码
2. 不分库。在数据库中大部分表上，都加一个 language 字段，用以区分数据来源
3. 不分库。在数据库中新建一张 `资源 <=> 来源` 的中间表。



## 三种方案如何解决上述的各种问题及难易程度：

### 使用方案  1  解决问题  1 ：

因为分站有自己的数据库和代码，可以不同过语言包，直接将原文案修改为指定语言文案。

- 难度：低
- 工作量：大
- 后期维护成本：高



### 使用方案 2 解决问题 1：

使用语言包可以解决，但会遇到 `并且有些提示是不支持语言包的（比如 API 项目中不同错误代码对应的提示）` 的问题，需要另外考虑解决方案

- 难度：低
- 工作量：大
- 后期维护成本：低

### 使用方案 3 解决问题 1：

同方案2









## 三种方案各自的优劣：



